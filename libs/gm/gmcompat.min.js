// ==UserScript==
// @exclude      *
// ==UserLibrary==
// @name         @journeyover/gmcompat
// @description  GM Compatibility Layer with Legacy Aliases
// @license      MIT
// @version      2.0.0
// @homepageURL  https://github.com/StylusThemes/Userscripts
// ==/UserLibrary==
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        GM.deleteValue
// @grant        GM.listValues
// @grant        GM.xmlHttpRequest
// @grant        GM.registerMenuCommand
// @grant        GM.addStyle
// @grant        GM.setClipboard
// @grant        GM.addValueChangeListener
// @grant        GM.removeValueChangeListener
// ==/UserScript==

const GMC=function(global){"use strict";const hasGM=typeof GM!=="undefined"&&GM!==null;const hasLegacy=typeof GM_getValue!=="undefined"||typeof GM_setValue!=="undefined";const isFn=v=>typeof v==="function";async function getValue(key,def){if(hasGM&&isFn(GM.getValue))return GM.getValue(key,def);if(isFn(GM_getValue)){try{const val=GM_getValue(key);return val===undefined?def:val}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.getValue not available"))}function setValue(key,value){if(hasGM&&isFn(GM.setValue))return GM.setValue(key,value);if(isFn(GM_setValue)){try{GM_setValue(key,value);return Promise.resolve()}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.setValue not available"))}function deleteValue(key){if(hasGM&&isFn(GM.deleteValue))return GM.deleteValue(key);if(isFn(GM_deleteValue)){try{GM_deleteValue(key);return Promise.resolve()}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.deleteValue not available"))}function listValues(){if(hasGM&&isFn(GM.listValues))return GM.listValues();if(isFn(GM_listValues)){try{return Promise.resolve(GM_listValues())}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.listValues not available"))}function xmlHttpRequest(details={}){return new Promise((resolve,reject)=>{const success=resp=>resolve(resp);const fail=err=>reject(err);if(hasGM&&isFn(GM.xmlHttpRequest)){const d={...details};if(!d.onload)d.onload=success;if(!d.onerror)d.onerror=fail;try{GM.xmlHttpRequest(d)}catch(e){reject(e)}return}if(isFn(GM_xmlhttpRequest)){const d={...details};if(!d.onload)d.onload=success;if(!d.onerror)d.onerror=fail;try{GM_xmlhttpRequest(d)}catch(e){reject(e)}return}reject(new Error("GM.xmlHttpRequest not available"))})}function setClipboard(data,type){if(hasGM&&isFn(GM.setClipboard)){try{return Promise.resolve(GM.setClipboard(data,type))}catch(e){return Promise.reject(e)}}if(isFn(GM_setClipboard)){try{GM_setClipboard(data,type);return Promise.resolve()}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.setClipboard not available"))}function addStyle(css){if(!css)return;if(hasGM&&isFn(GM.addStyle)){try{return GM.addStyle(css)}catch(e){}}if(isFn(GM_addStyle)){try{return GM_addStyle(css)}catch(e){}}return Promise.reject(new Error("GM.addStyle not available"))}function registerMenuCommand(caption,fn,accessKey){if(hasGM&&isFn(GM.registerMenuCommand)){try{return Promise.resolve(GM.registerMenuCommand(caption,fn,accessKey))}catch(e){return Promise.reject(e)}}if(isFn(GM_registerMenuCommand)){try{return Promise.resolve(GM_registerMenuCommand(caption,fn,accessKey))}catch(e){return Promise.reject(e)}}return Promise.reject(new Error("GM.registerMenuCommand not available"))}function addValueChangeListener(name,fn){if(hasGM&&isFn(GM.addValueChangeListener)){return GM.addValueChangeListener(name,fn)}if(isFn(GM_addValueChangeListener)){return GM_addValueChangeListener(name,fn)}return Promise.reject(new Error("GM.addValueChangeListener not available"))}function removeValueChangeListener(id){if(hasGM&&isFn(GM.removeValueChangeListener)){return GM.removeValueChangeListener(id)}if(isFn(GM_removeValueChangeListener)){return GM_removeValueChangeListener(id)}return Promise.reject(new Error("GM.removeValueChangeListener not available"))}const __internal={hasGM:hasGM,hasLegacy:hasLegacy,available:{getValue:hasGM?isFn(GM.getValue):isFn(GM_getValue),setValue:hasGM?isFn(GM.setValue):isFn(GM_setValue),deleteValue:hasGM?isFn(GM.deleteValue):isFn(GM_deleteValue),listValues:hasGM?isFn(GM.listValues):isFn(GM_listValues),xmlHttpRequest:hasGM?isFn(GM.xmlHttpRequest):isFn(GM_xmlhttpRequest),registerMenuCommand:hasGM?isFn(GM.registerMenuCommand):isFn(GM_registerMenuCommand),addStyle:hasGM?isFn(GM.addStyle):isFn(GM_addStyle),setClipboard:hasGM?isFn(GM.setClipboard):isFn(GM_setClipboard),addValueChangeListener:hasGM?isFn(GM.addValueChangeListener):isFn(GM_addValueChangeListener),removeValueChangeListener:hasGM?isFn(GM.removeValueChangeListener):isFn(GM_removeValueChangeListener)}};const API={getValue:getValue,setValue:setValue,deleteValue:deleteValue,listValues:listValues,xmlHttpRequest:xmlHttpRequest,setClipboard:setClipboard,addStyle:addStyle,registerMenuCommand:registerMenuCommand,addValueChangeListener:addValueChangeListener,removeValueChangeListener:removeValueChangeListener,__internal:__internal};global.GMC=API;global.GM_getValue=API.getValue;global.GM_setValue=API.setValue;global.GM_deleteValue=API.deleteValue;global.GM_listValues=API.listValues;global.GM_xmlhttpRequest=API.xmlHttpRequest;global.GM_setClipboard=API.setClipboard;global.GM_addStyle=API.addStyle;global.GM_registerMenuCommand=API.registerMenuCommand;global.GM_addValueChangeListener=API.addValueChangeListener;global.GM_removeValueChangeListener=API.removeValueChangeListener;return API}(typeof unsafeWindow!=="undefined"?unsafeWindow:window);
